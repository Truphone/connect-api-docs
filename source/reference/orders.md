# Orders

## Order Resource

SIM's and connectivity plans are purchased by creating orders. Order fulfilment is asynchronous due to the nature of SIM and network provisioning. Typical use cases include creating an order and polling for the status shortly after.

### Properties

|     Property Name      |                                                             Description                                                              |
| :--------------------: | :----------------------------------------------------------------------------------------------------------------------------------: |
|           id           | Order identifier, generated by Truphone, for tracking the order.<br/>Users should store this value in order to poll for order status |
|         status         |                                            Order status: `COMPLETED`/`FAILED`/`FULFILING`                                            |
|         input          |                                    Data required to process the order. Depends on the order type                                     |
|         output         |                                                   Produced output after completed                                                    |
|      output.iccid      |                                                       eSIM Profile identifier                                                        |
|   output.matchingId    |                                                         eSIM Activation Code                                                         |
|     output.smdpUrl     |                                                         SM-DP+ Instance URL                                                          |
|     output.lpa_url     |                                                   LPA URL for generating a QR Code                                                   |
| output.subscription_id |                                           The id of the subscription that was just created                                           |

**Possible values for `status`**

| Property Name |                     Description                     |
| :-----------: | :-------------------------------------------------: |
|   FAILED    |     The order failed provisioning the product    |
|    COMPLETED     |            The order was finished with success           |
|    FULFILLING    | The order is still being processed |
|    ACCEPTED    | The order is waiting to be processed         |

## Purchase a New eSIM

Customer does not own a Truphone SIM and wants to order one. This operation provisions/activates a SIM for installing on a given device and adds a data plan to it.

- Allowed roles: `RESELLER`, `ACCOUNT_MANAGER`
- URL: `v1/order`
- METHOD: `POST`

### Parameters

|         Parameter Name         |                                       Description                                        | Required |
| :----------------------------: | :--------------------------------------------------------------------------------------: | :------: |
|         operationType          |                                    Must be `NEW_ESIM`                                    |   yes    |
|          countryCode           |                         Country where the order is being placed                          |   yes    |
|            customer            |                     End customer who is purchasing the subscription                      |   yes    |
|         customer.email         |                            End customer's email or identifier                            |   yes    |
|       customer.firstName       |                                End customer's first name                                 |    no    |
|       customer.lastName        |                                 End customer's last name                                 |    no    |
|  customer.countryOfResidence   |                           End customer's country of residence                            |    np    |
|             device             |                     Device where the subscription will be installed                      |   yes    |
|          device.type           |                                `ios`, `android` or `iot`                                 |   yes    |
|           device.id            |                             Unique identifier for the device                             |   yes    |
|          device.model          |                                       Device Model                                       |    no    |
|           device.eid           |                                        Device Eid                                        |    no    |
|          device.make           |                                       Device Make                                        |    no    |
|         subscriptions          | List of products to purchase. <br />Each SIM can only have up to 15 active subscriptions |   yes    |
|   subscriptions[].product_id   |                              Id of the product to purchase                               |   yes    |
| subscriptions[].activationDate |                          Date when the product can be activated                          |    no    |
|     subscriptions[].price      |                           Price for which the product was sold net of sales tax (remove the sales tax)                           |    no    |
|    subscriptions[].currency    |                         Currency for which the product was sold                          |    no    |

### Rules and validations

- If the customer does not exist it will be created
- `subscriptions.product_id` - Needs to be an id that belongs to the product catalog of the customer
- `subscriptions.activationDate` - Can not be a date in the past
- `subscriptions.price` - If is sent, it must be sent in pair with `subscriptions.currency`
- `subscriptions.currency` - If is sent, it must be sent in pair with `subscriptions.price` and needs to be one of the currencies supported by the customer
- `device.type` - Can vary between the three above specified but must respect the contract

### Example Request

```bash
curl -X POST \
  https://services.truphone.com/connect-api/v1/order \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json' \
  -H 'X-Correlation-ID: unique-id-from-requester-123' \
  -d '{
      	"input": {
            "operationType": "NEW_ESIM",
            "countryCode": "PT",
            "customer": {
                "email": "john@doe.com",
                "countryOfResidence": "US"
            },
            "device": {
                "id": "123456789",
                "model": "iPhone",
                "type": "ios",
                "eid": "89049032004008882600019002596666"
            },
      	    "subscriptions": [{
      	        "product_id": "a3u3z000000PZBhAAO",
      	        "activationDate": "2019-09-13T12:00:00Z",
      	        "price": 10,
      	        "currency": "USD"
      	    }]
      	}
      }'
```

### Example Response

```json
{
  "id": "3a6acf89-1ccf-4611-9424-453930f57ef1",
  "externalId": "3a6acf89-1ccf-4611-9424-453930f57ef1",
  "status": "ACCEPTED"
}
```

## Purchase a Top-Up

A Truphone SIM was already provided. Topping up will add connectivity plans to this SIM

- Allowed roles: `RESELLER`, `ACCOUNT_MANAGER`
- URL: `v1/order`
- METHOD: `POST`

### Parameters

|         Parameter Name         |                                       Description                                        |   Required   | Default |
| :----------------------------: | :--------------------------------------------------------------------------------------: | :----------: | :-----: |
|         operationType          |                                     Must be `TOPUP`                                      |     yes      |         |
|          countryCode           |                         Country where the order is being placed                          | configurable |         |
|            customer            |                     End customer who is purchasing the subscription                      |      no      |         |
|         customer.email         |                            End customer's email or identifier                            |      no      |         |
|             device             |                     Device where the subscription will be installed                      |     yes      |         |
|          device.type           |                                `ios`, `android` or `iot`                                 |      no      |         |
|           device.id            |                             Unique identifier for the device                             |     yes      |         |
|          device.model          |                                       Device Model                                       |      no      |         |
|          device.make           |                                       Device Make                                        |      no      |         |
|         subscriptions          | List of products to purchase. <br />Each SIM can only have up to 15 active subscriptions |     yes      |         |
|   subscriptions[].product_id   |                              Id of the product to purchase                               |     yes      |         |
| subscriptions[].activationDate |                          Date when the product can be activated                          |      no      |         |
|     subscriptions[].price      |       Price for which the product was sold net of sales tax (remove the sales tax)       |      no      |         |
|    subscriptions[].currency    |                         Currency for which the product was sold                          |      no      |         |
|              esim              |                          The eSIM to which add the subscription                          |     yes      |         |
|           esim.iccid           |                        The iccid corresponding to the subscriber                         |     yes      |         |

### Rules and validations

- `operationType` - Needs to be `TOPUP` (preferred) or `TOPUP_ACTIVATION` (deprecated)
- `subscriptions.product_id` - Needs to be an id belonging to the product catalog of the customer
- `subscriptions.activationDate` - Can not be a date in the past
- `subscriptions.price` - If is sent, it must be sent in pair with `subscriptions.currency`
- `subscriptions.currency` - If is sent, it must be sent in pair with `subscriptions.price` and needs to be one of the currencies supported by the client
- `device.type` - Can vary between the three above specified but must respect the contract
- `customer` - Deprecated (Can be sent but it's not necessary)

In order to call this endpoint, `esim.iccid` node is mandatory, otherwise the topup won't be performed:

- `esim` and `esim.iccid` are mandatory
- `esim.iccid` - the iccid obtained when the first eSIM was ordered.

There is also a hard limit of 15 **active** subscriptions for the same iccid. This means that if an order for a topup operation for an iccid that already has 15 **active** subscriptions is created, the user will get an error.

Be aware that on this scenario, the `matchingId` won't be returned when the order is completed.

### Example Request

```bash
curl -X POST \
  https://services.truphone.com/connect-api/v1/order \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json' \
  -H 'X-Correlation-ID: unique-id-from-requester-123' \
  -d '{
      	"input": {
            "operationType": "TOPUP_ACTIVATION",
            "countryCode": "PT",
            "device": {
                "id": "234frfa-ad36-45ab-8e2f-3423edaed3",
                "model": "iPhone",
                "type": "ios",
                "eid": "89049032004008882600019002596666"
            },
            "subscriptions": [{
      	        "product_id": "h9_dkisesqdE8-xmyY11BqJjKhAen-jwQPNLIgRbvZo=",
      	        "activationDate": "2019-09-13T12:00:00Z",
      	        "price": 10,
      	        "currency": "USD"
      	    }],
      	    "esim": {
      	        "iccid": "8944478600000205337"
      	    }
      	}
      }'
```

### Example Response

```json
{
  "id": "3a6acf89-1ccf-4611-9424-453930f57ef1",
  "externalId": "3a6acf89-1ccf-4611-9424-453930f57ef1",
  "status": "ACCEPTED"
}
```

## Check an order's status

Order fulfilment is not synchronous, so after placing an order, the API user must use the order id to periodically check until the order is complete

- Allowed roles: `RESELLER`, `ACCOUNT_MANAGER`
- URL: `v1/order/{orderId}`
- METHOD: `GET`

### Example Request

```bash
curl -X GET \
  https://services.truphone.com/connect-api/v1/order/3a6acf89-1ccf-4611-9424-453930f57ef1 \
   -H "Authorization: Bearer $ACCESS_TOKEN" \
   -H 'Cache-Control: no-cache' \
   -H 'Content-Type: application/json' \
   -H 'X-Correlation-ID: unique-id-from-requester-123'
```

### Example Response

```json
{
  "output": {
    "matchingId": "5C-M1OIY-QHWKD1",
    "iccid": "8944478600000205337",
    "smdpUrl": "rsp.truphone.com",
    "lpa_url": "LPA:1$%rsp.truphone.com$%5C-M1OIY-QHWKD1",
    "subscription_id": "a-5gVXH2sjvICL7U5roet1hMC35UYSCCi4Mbiszdceo="
  },
  "status": "COMPLETED",
  "id": "b27ec0e7-ad36-45ab-8e2f-c291441a2355"
}
```
